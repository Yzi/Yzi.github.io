<!doctype html><html lang=zh><head><meta http-equiv=x-clacks-overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=https://Yzi.io/images/favicon.png><title>ESXi 部署 Ubuntu Cloud Image | Yzi Blog</title><meta name=title content="ESXi 部署 Ubuntu Cloud Image"><meta name=description content="需要一个干净的基础镜像，并且在几分钟之内即可启动并运行虚拟机，Multipass Mac 或 Windows 工作站上的迷你云，作为开发使用特别方便，但部署一个长期运行的服务器时，使用起来不太适合。
Ubuntu Cloud Images 是官方的Ubuntu映像，并且在镜像中集成了 Cloud Init，Cloud Init 是用于跨平台云实例初始化的行业标准，作为基础镜像最合适不过，实现磁盘开机时的自动扩容，只需配置：
# cloud-config rowpart: mode: auto devices: ['/'] Ubuntu Cloud Images 下载镜像中提供的 开放虚拟机格式文件（Open Virtualization Format，OVF），可以直接部署到 ESXi，并且导入时能直接填写密码或其他配置，开箱即用。
下载镜像后，登陆 ESXi Web 客户端，创建/注册虚拟机，选择 从 OVF 或 OVA 文件部署虚拟机，在页面中填入密码，等待导入完成，即可启动虚拟机。
但是，进入系统后登陆却提示密码错误，一番查阅资料后，在一篇博客 How to finally inject OVF properties into VCSA when deploying directly onto ESXi? 找到原因。
 OVF 属性的工作方式是：通过 VMware Tools 注入虚拟设备，并在打开虚拟设备电源时将其注入 OVF 运行时环境。如果用户决定在部署后不立即打开虚拟设备电源，则必须保留 OVF 属性及其值。对于 vCenter Server，我们有一个数据库，可以在其中存储 OVF 属性，但是对于 ESXi，不存在可以正确存储 OVF 属性的数据库，这就是 ESXi 不支持它们的原因。"><meta name=keywords content="HomeLab,ESXi,"><meta property="og:title" content="ESXi 部署 Ubuntu Cloud Image"><meta property="og:description" content="需要一个干净的基础镜像，并且在几分钟之内即可启动并运行虚拟机，Multipass Mac 或 Windows 工作站上的迷你云，作为开发使用特别方便，但部署一个长期运行的服务器时，使用起来不太适合。
Ubuntu Cloud Images 是官方的Ubuntu映像，并且在镜像中集成了 Cloud Init，Cloud Init 是用于跨平台云实例初始化的行业标准，作为基础镜像最合适不过，实现磁盘开机时的自动扩容，只需配置：
# cloud-config rowpart: mode: auto devices: ['/'] Ubuntu Cloud Images 下载镜像中提供的 开放虚拟机格式文件（Open Virtualization Format，OVF），可以直接部署到 ESXi，并且导入时能直接填写密码或其他配置，开箱即用。
下载镜像后，登陆 ESXi Web 客户端，创建/注册虚拟机，选择 从 OVF 或 OVA 文件部署虚拟机，在页面中填入密码，等待导入完成，即可启动虚拟机。
但是，进入系统后登陆却提示密码错误，一番查阅资料后，在一篇博客 How to finally inject OVF properties into VCSA when deploying directly onto ESXi? 找到原因。
 OVF 属性的工作方式是：通过 VMware Tools 注入虚拟设备，并在打开虚拟设备电源时将其注入 OVF 运行时环境。如果用户决定在部署后不立即打开虚拟设备电源，则必须保留 OVF 属性及其值。对于 vCenter Server，我们有一个数据库，可以在其中存储 OVF 属性，但是对于 ESXi，不存在可以正确存储 OVF 属性的数据库，这就是 ESXi 不支持它们的原因。"><meta property="og:type" content="article"><meta property="og:url" content="https://Yzi.io/blog/cloud-init-and-ubuntu-cloud-images-with-esxi/"><meta property="og:image" content="https://Yzi.io/images/share.png"><meta property="article:published_time" content="2021-01-02T13:55:45+08:00"><meta property="article:modified_time" content="2021-01-02T13:55:45+08:00"><meta property="og:site_name" content="Yzi Blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://Yzi.io/images/share.png"><meta name=twitter:title content="ESXi 部署 Ubuntu Cloud Image"><meta name=twitter:description content="需要一个干净的基础镜像，并且在几分钟之内即可启动并运行虚拟机，Multipass Mac 或 Windows 工作站上的迷你云，作为开发使用特别方便，但部署一个长期运行的服务器时，使用起来不太适合。
Ubuntu Cloud Images 是官方的Ubuntu映像，并且在镜像中集成了 Cloud Init，Cloud Init 是用于跨平台云实例初始化的行业标准，作为基础镜像最合适不过，实现磁盘开机时的自动扩容，只需配置：
# cloud-config rowpart: mode: auto devices: ['/'] Ubuntu Cloud Images 下载镜像中提供的 开放虚拟机格式文件（Open Virtualization Format，OVF），可以直接部署到 ESXi，并且导入时能直接填写密码或其他配置，开箱即用。
下载镜像后，登陆 ESXi Web 客户端，创建/注册虚拟机，选择 从 OVF 或 OVA 文件部署虚拟机，在页面中填入密码，等待导入完成，即可启动虚拟机。
但是，进入系统后登陆却提示密码错误，一番查阅资料后，在一篇博客 How to finally inject OVF properties into VCSA when deploying directly onto ESXi? 找到原因。
 OVF 属性的工作方式是：通过 VMware Tools 注入虚拟设备，并在打开虚拟设备电源时将其注入 OVF 运行时环境。如果用户决定在部署后不立即打开虚拟设备电源，则必须保留 OVF 属性及其值。对于 vCenter Server，我们有一个数据库，可以在其中存储 OVF 属性，但是对于 ESXi，不存在可以正确存储 OVF 属性的数据库，这就是 ESXi 不支持它们的原因。"><meta itemprop=name content="ESXi 部署 Ubuntu Cloud Image"><meta itemprop=description content="需要一个干净的基础镜像，并且在几分钟之内即可启动并运行虚拟机，Multipass Mac 或 Windows 工作站上的迷你云，作为开发使用特别方便，但部署一个长期运行的服务器时，使用起来不太适合。
Ubuntu Cloud Images 是官方的Ubuntu映像，并且在镜像中集成了 Cloud Init，Cloud Init 是用于跨平台云实例初始化的行业标准，作为基础镜像最合适不过，实现磁盘开机时的自动扩容，只需配置：
# cloud-config rowpart: mode: auto devices: ['/'] Ubuntu Cloud Images 下载镜像中提供的 开放虚拟机格式文件（Open Virtualization Format，OVF），可以直接部署到 ESXi，并且导入时能直接填写密码或其他配置，开箱即用。
下载镜像后，登陆 ESXi Web 客户端，创建/注册虚拟机，选择 从 OVF 或 OVA 文件部署虚拟机，在页面中填入密码，等待导入完成，即可启动虚拟机。
但是，进入系统后登陆却提示密码错误，一番查阅资料后，在一篇博客 How to finally inject OVF properties into VCSA when deploying directly onto ESXi? 找到原因。
 OVF 属性的工作方式是：通过 VMware Tools 注入虚拟设备，并在打开虚拟设备电源时将其注入 OVF 运行时环境。如果用户决定在部署后不立即打开虚拟设备电源，则必须保留 OVF 属性及其值。对于 vCenter Server，我们有一个数据库，可以在其中存储 OVF 属性，但是对于 ESXi，不存在可以正确存储 OVF 属性的数据库，这就是 ESXi 不支持它们的原因。"><meta itemprop=datePublished content="2021-01-02T13:55:45+08:00"><meta itemprop=dateModified content="2021-01-02T13:55:45+08:00"><meta itemprop=wordCount content="101"><meta itemprop=image content="https://Yzi.io/images/share.png"><meta itemprop=keywords content="HomeLab,ESXi,"><meta name=referrer content="no-referrer-when-downgrade"><style>body{font-family:Verdana,sans-serif;margin:auto;padding:20px;max-width:720px;text-align:left;background-color:#fff;word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:#444}h1,h2,h3,h4,h5,h6,strong,b{color:#222}a{color:#3273dc}.title{text-decoration:none;border:0}.title span{font-weight:400}nav a{margin-right:10px}textarea{width:100%;font-size:16px}input{font-size:16px}content{line-height:1.6}table{width:100%}img{max-width:100%}code{padding:2px 5px;background-color:#f2f2f2}pre code{color:#222;display:block;padding:20px;white-space:pre-wrap;font-size:14px}blockquote{border-left:1px solid #999;color:#222;padding-left:20px;font-style:italic}footer{padding:25px;text-align:center}.helptext{color:#777;font-size:small}.errorlist{color:#eba613;font-size:small}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}@media(prefers-color-scheme:dark){body{background-color:#333;color:#ddd}h1,h2,h3,h4,h5,h6,strong,b{color:#eee}a{color:#8cc2dd}code{background-color:#777}pre code{color:#ddd}blockquote{color:#ccc}textarea,input{background-color:#252525;color:#ddd}.helptext{color:#aaa}}</style></head><body><header><a href=/ class=title><h2>Yzi Blog</h2></a><nav><a href=/>Home</a>
<a href=/blog>Blog</a></nav></header><main><h1>ESXi 部署 Ubuntu Cloud Image</h1><p><i><time datetime=2021-01-02 pubdate>02 Jan, 2021</time></i></p><content><p>需要一个干净的基础镜像，并且在几分钟之内即可启动并运行虚拟机，<a href=https://multipass.run>Multipass</a> Mac 或 Windows 工作站上的迷你云，作为开发使用特别方便，但部署一个长期运行的服务器时，使用起来不太适合。</p><p><a href=https://cloud-images.ubuntu.com>Ubuntu Cloud Images</a> 是官方的Ubuntu映像，并且在镜像中集成了 <a href=https://cloudinit.readthedocs.io>Cloud Init</a>，Cloud Init 是用于跨平台云实例初始化的行业标准，作为基础镜像最合适不过，实现磁盘开机时的自动扩容，只需配置：</p><pre><code># cloud-config
rowpart:
  mode: auto
  devices: ['/']
</code></pre><p>Ubuntu Cloud Images 下载镜像中提供的 <a href=https://zh.wikipedia.org/zh-hans/%E5%BC%80%E6%94%BE%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%A0%BC%E5%BC%8F%E6%96%87%E4%BB%B6>开放虚拟机格式文件（Open Virtualization Format，OVF）</a>，可以直接部署到 ESXi，并且导入时能直接填写密码或其他配置，开箱即用。</p><p>下载镜像后，登陆 ESXi Web 客户端，创建/注册虚拟机，选择 从 OVF 或 OVA 文件部署虚拟机，在页面中填入密码，等待导入完成，即可启动虚拟机。</p><p><img src=https://i.v2ex.co/WP4uVx9H.png alt></p><p>但是，进入系统后登陆却提示密码错误，一番查阅资料后，在一篇博客 <a href=https://www.virtuallyghetto.com/2014/05/how-to-finally-inject-ovf-properties-into-vcsa-when-deploying-directly-onto-esxi.html>How to finally inject OVF properties into VCSA when deploying directly onto ESXi?</a> 找到原因。</p><blockquote><p>OVF 属性的工作方式是：通过 VMware Tools 注入虚拟设备，并在打开虚拟设备电源时将其注入 OVF 运行时环境。如果用户决定在部署后不立即打开虚拟设备电源，则必须保留 OVF 属性及其值。对于 vCenter Server，我们有一个数据库，可以在其中存储 OVF 属性，但是对于 ESXi，不存在可以正确存储 OVF 属性的数据库，这就是 ESXi 不支持它们的原因。</p></blockquote><p>文章中有多种方式解决这个问题，因为只部署了单台 ESXi，所以此处选择手动注入的方式，参考 <a href=https://www.virtuallyghetto.com/2014/06/an-alternate-way-to-inject-ovf-properties-when-deploying-virtual-appliances-directly-onto-esxi.html>An alternate way to inject OVF properties when deploying virtual appliances directly onto ESXi</a> ，这是在直接部署到 ESXi 时使 OVF 属性起作用的巧妙方法，使用手动注入的方式，对于需要密码的虚拟机，还需要在 guestinfo.ovfEnv 中公开纯文本密码，不建议使用该方法。</p><p><img src=https://i.v2ex.co/mPq8az2S.png alt></p><p>到此，虚拟机启动完成，在控制台中，可以通过命令 <code>vmtoolsd --cmd 'info-get guestinfo.ovfEnv'</code> 检查注入的 OVF 属性。</p><p><img src=https://i.v2ex.co/yxO92vVl.png alt></p></content><p><a href=https://Yzi.io/blog/homelab/>#HomeLab</a>
<a href=https://Yzi.io/blog/esxi/>#ESXi</a></p></main><footer><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-183049007-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><div id=disqus_thread></div><script>function d(t){return document.createElement(t);}
function u(t,a,n){var s=d("script");s.src=t,a&&(s.onload=a),n&&(s.type="module"),s.async=!0,s.crossOrigin="anonymous",document.body.appendChild(s)}
function loadDisqus(){var t=d("link");t.rel="stylesheet",t.href="https://cdn.jsdelivr.net/npm/sks@0.2.8/disqusjs.css",t.crossOrigin="anonymous",t.media="print",t.onload=function(){t.media="all",t.onload=null},document.head.appendChild(t);u("https://cdn.jsdelivr.net/npm/disqusjs@1.3.0/dist/disqus.js",function(){new DisqusJS({shortname:"yzi",api:"https://disqus.yzi.io/api/",apikey:"AmJsSVQd4S5jFk8Uo40Cl87RtltZmpSM0JlIGz3O194CkjqXvzkHkEDWMHxPeTLp",admin:"Yzi"})})}
var runningOnBrowser=typeof window!=="undefined";var isBot=runningOnBrowser&&!("onscroll"in window)||typeof navigator!=="undefined"&&/(gle|ing|ro|msn)bot|crawl|spider|yand|duckgo/i.test(navigator.userAgent);var supportsIntersectionObserver=runningOnBrowser&&"IntersectionObserver"in window;setTimeout(function(){if(!isBot&&supportsIntersectionObserver){var disqus_observer=new IntersectionObserver(function(entries){if(entries[0].isIntersecting){loadDisqus();disqus_observer.disconnect();}},{threshold:[0]});disqus_observer.observe(document.getElementById('disqus_thread'));}else{loadDisqus();}},1);</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript>Made with <a href=https://github.com/janraasch/hugo-bearblog/>Hugo ʕ•ᴥ•ʔ Bear</a></footer></body></html>